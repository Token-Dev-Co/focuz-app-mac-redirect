<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processing...</title>
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            padding: 50px;
        }
    </style>
    <script>
        window.onload = function () {
            // --- SECURITY CHECKS ---
            const referrer = document.referrer;
            const isFromStripe = referrer.includes("stripe.com");

            const urlParams = new URLSearchParams(window.location.search);
            const secret = urlParams.get('key');

            const MY_SECRET = '91a0ffb585392eeaaf7b497d942baa2dee03bf7b29cdc71c770da0fb9908fbde';

            if (secret === MY_SECRET && isFromStripe) {
                // Success!
                document.body.innerHTML = "<h1>Finalizing...</h1>";

                // Redirect to App
                window.location.href = "zf://upgrade-success";

                // Aguardar um momento para que o redirecionamento seja processado
                // e então fechar a janela
                setTimeout(() => {
                    // Método 1: Tentar fechar normalmente
                    try {
                        window.close();
                    } catch (e) {
                        // Se falhar, tentar métodos alternativos
                        console.log("Tentando método alternativo para fechar janela...");
                        
                        // Método 2: Abrir uma URL vazia no mesmo contexto
                        window.open('', '_self', '');
                        window.close();
                        
                        // Método 3: Para alguns navegadores, tentar com um pequeno delay
                        setTimeout(() => {
                            window.close();
                        }, 100);
                    }
                }, 100); // Aguardar 100ms para o redirecionamento
                
            } else {
                // Failed
                console.error("Access denied. Referrer:", referrer);
                document.body.innerHTML = "<h1>403 Forbidden</h1><p>Invalid access token.</p>";
            }
        };
    </script>
</head>

<body>
    <p>Please wait...</p>
</body>

</html>
